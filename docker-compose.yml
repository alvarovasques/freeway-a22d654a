version: "3.8"

services:
  freewaynet:
    image: registry.your-registry.com/freewaynet:latest  # serÃ¡ sobrescrito pelo GitHub Actions
    networks:
      - di4e
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=di4e"

        # Router principal: freewaynet.com.br (HTTPS)
        - "traefik.http.routers.freewaynet.rule=Host(`freewaynet.com.br`)"
        - "traefik.http.routers.freewaynet.entrypoints=websecure"
        - "traefik.http.routers.freewaynet.tls=true"
        - "traefik.http.routers.freewaynet.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.freewaynet.service=freewaynet"

        # Router www: redireciona www para sem www (301)
        - "traefik.http.routers.freewaynet-www.rule=Host(`www.freewaynet.com.br`)"
        - "traefik.http.routers.freewaynet-www.entrypoints=websecure"
        - "traefik.http.routers.freewaynet-www.tls=true"
        - "traefik.http.routers.freewaynet-www.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.freewaynet-www.middlewares=redirect-www"
        - "traefik.http.routers.freewaynet-www.service=freewaynet"

        # Middleware 301 www -> sem www
        - "traefik.http.middlewares.redirect-www.redirectregex.regex=^https://www\\.freewaynet\\.com\\.br/(.*)"
        - "traefik.http.middlewares.redirect-www.redirectregex.replacement=https://freewaynet.com.br/$${1}"
        - "traefik.http.middlewares.redirect-www.redirectregex.permanent=true"

        # Service
        - "traefik.http.services.freewaynet.loadbalancer.server.port=80"

networks:
  di4e:
    external: true
